#!/usr/bin/env bash
set -euo pipefail

# SPDX-FileCopyrightText: 2023 Gergely Horv√°th
# SPDX-License-Identifier: AGPL-3.0-or-later

# Resolve running container by name each run (leading slash anchor)
cid="$(docker ps -q -f name=^/{{ nextcloud_identifier }}-server$ || true)"
if [ -z "${cid}" ]; then
  echo "Nextcloud server container not running; skipping preview generation."
  exit 0
fi

# Run preview generation as the configured Nextcloud user/group
exec docker exec -u {{ nextcloud_uid }}:{{ nextcloud_gid }} \
  "${cid}" php /var/www/html/occ preview:generate-all -vvv
